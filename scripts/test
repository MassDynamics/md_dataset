#!/bin/bash

set -e

if [ -z "${CONDA_ENV_NAME}" ]; then
    echo "Error: CONDA_ENV_NAME environment variable is not set"
    exit 1
fi

if ! (( $(conda env list | grep "^${CONDA_ENV_NAME}[[:space:]]*" >/dev/null 2>&1)) ); then
  echo "creating conda environment ${CONDA_ENV_NAME}"
  conda create -y --name $CONDA_ENV_NAME python=3.11
fi

echo "installing packages into ${CONDA_ENV_NAME}"

# Install AWS CLI if not available
if ! command -v aws &> /dev/null; then
    echo "AWS CLI not found, installing..."
    if command -v pip &> /dev/null; then
        pip install awscli
    elif command -v pip3 &> /dev/null; then
        pip3 install awscli
    else
        echo "Error: pip not found, cannot install AWS CLI"
        exit 1
    fi
fi

github_token=$(aws ssm get-parameter --name "/services/github/key" --with-decryption --query "Parameter.Value" --output text)
export GH_TOKEN=$github_token
echo "GH_TOKEN: ${GH_TOKEN:0:5}*****"
conda run -n $CONDA_ENV_NAME bash -c "python -m pip install -e '.[dev]'"

TZ=UTC conda run -n $CONDA_ENV_NAME bash -c "pytest -n auto"
