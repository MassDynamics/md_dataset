#!/bin/bash

set -e

if [ -z "${CONDA_ENV_NAME}" ]; then
    echo "Error: CONDA_ENV_NAME environment variable is not set"
    exit 1
fi

if ! (( $(conda env list | grep "^${CONDA_ENV_NAME}[[:space:]]*" >/dev/null 2>&1)) ); then
  echo "creating conda environment ${CONDA_ENV_NAME}"
  conda create -y --name $CONDA_ENV_NAME python=3.11
fi

echo "installing packages into ${CONDA_ENV_NAME}"
python3 -m venv venv
source venv/bin/activate
github_token=$(aws ssm get-parameter --name "/services/github/key" --with-decryption --query "Parameter.Value" --output text)
export GH_TOKEN=$github_token
echo "GH_TOKEN: ${GH_TOKEN:0:5}*****"
conda run -n $CONDA_ENV_NAME bash -c "python -m pip install -e '.[dev]'"

TZ=UTC conda run -n $CONDA_ENV_NAME bash -c "pytest -n auto"
